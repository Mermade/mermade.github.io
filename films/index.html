<html>
<head>
	<link rel="stylesheet" type="text/css" href="/stylesheets/stylesheet.css" media="screen">
	<link rel="stylesheet" type="text/css" href="/stylesheets/github-dark.css" media="screen">
	<link rel="stylesheet" type="text/css" href="/stylesheets/datatables.css" media="screen">
	<link rel="stylesheet" type="text/css" href="/stylesheets/colorbox.css" media="screen">

	<script src="/javascripts/jQuery-min.js"></script>
	<script src="/javascripts/dataTables.js"></script>
	<script src="/javascripts/jquery.colorbox-min.js"></script>

    <title>Software by Mermade</title>
</head>
<body>
    <header>
      <div class="container">
        <h1><a href="/index.html">Mermade Software</a> / Films</h1>
        <h2>Itches elegantly scratched</h2>

        <section id="downloads">
          <a href="https://github.com/Mermade" class="btn btn-github"><span class="icon"></span>Follow us on GitHub</a>
		  <a id="aPassHash" href="/static/passwordHasher.html" class="btn btn-passwd"><span class="icon"></span>Generate secure passwords</a>
		  <a href="mailto:meic@gmx.com" class="btn btn-mail"><span class="icon"></span>Contact us</a>
		  <a href="http://mikeralphson.github.io/" class="btn btn-blog"><span class="icon"></span>Blog</a>
		</section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">

	  <table id="tblMain" class="compact nowrap">
	  <thead>
	  <tr><td>Channel</td><td>Rating</td><td>Len</td><td>Time</td><td>Genre</td><td>Year</td></tr>
	  </thead>
	  <tbody>
	  </tbody>
	  </table>

      </section>
    </div>
</body>
<script type="text/javascript">
	var channels = ['1073','3605'];
	function channel(c) {
		if (c == '1073') return 'Film4';
		if (c == '3605') return 'Horror';
	}
	$(document).ready(function(){
		var first = true;
		var table = $('#tblMain').DataTable({
			"order": [[ 2, "asc" ]]
		});
		var minLength = 61; // minutes
		var processOmdb = function(data) {
			table.rows().every(function () {
				var d = this.data();
				if (d[2].indexOf('>'+data.Title+'</')>=0) {
					d[1] = data.imdbRating;
					d[4] = data.Genre;
					d[5] = data.Year;
				}
				this.data(d);
			});
			table.draw();
		};
		var processResults = function(data) {
			try {
				//alert(data);
				var obj = JSON.parse(data);
				var rows = [];
				for (var l in obj.listings) {
					var row = [];
					row.push(channel(obj.channelId));
					row.push('');
					row.push(obj.listings[l].title);
					row.push(Math.floor(obj.listings[l].length/60));
					row.push('Unknown');
					row.push('Unknown');
					if ((row[3]>=minLength) && (row[2].indexOf('Teleshopping')<0)) {
						var found = false;
						var existing = table.column(2).data();
						for (var r in existing) {
							//console.log(JSON.stringify(existing[r],null,2));
							if ((typeof existing[r] == 'string') && (existing[r].indexOf('">'+row[2]+'</a>')>=0)) found = true;
						}
						if (!found) {
							if (first) {
								$.ajax('http://omdbapi.com/?t='+encodeURIComponent(row[2])+'&type=movie').done(processOmdb);
							}
							//first = false;
							row[2] = '<a href="/films/detail.html?c='+obj.channelId+'&e='+obj.listings[l].eventId+'">'+row[2]+'</a>';
							rows.push(row);
						}
					}
				}
				table.rows.add(rows).draw();
			}
			catch (e) {
				alert(e);
			}
		};
		$("#aPassHash").colorbox({iframe:true, width:"410", height:"90%"});
		var day = new Date();
		for (var d=0;d<7;d++) {
			var dateStr = day.toISOString().slice(0, 10);
			for (var c in channels) {
				$.ajax('http://bbc-rss.herokuapp.com/sky/tv/api/epg/listings/'+channels[c]+'/'+dateStr).done(processResults);
			}
			day = new Date(day.setTime(day.getTime() + 1 * 86400000));
		}
		$(document).ajaxError(function(event, jqxhr, settings, thrownError) {
			//alert('No data returned: '+thrownError+' '+settings.url);
			////if (table) {
			////	table.clear().draw();
			////}
		});
	});
</script>
</html>